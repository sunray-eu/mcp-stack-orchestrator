# MCP Stack Quickstart

Naming convention in production runtime:
- Containers: `ai-mcp-*`
- Supabase project: `ai-mcp-archon`
- Managed MCP servers: `mcpx-*`
- Image/version matrix: `<STACK_ROOT>/infra/versions.env`

## 1) Start Infra

Prerequisite for docs-mcp vector search:
- Set `OPENAI_API_KEY` (or another supported embedding provider key) in `<STACK_ROOT>/.secrets.env`.
- Optional override: `DOCS_MCP_EMBEDDING_MODEL` in `<STACK_ROOT>/.secrets.env`.
- If `DOCS_MCP_EMBEDDING_MODEL` is omitted and `OPENAI_API_KEY` exists, stack scripts default to `text-embedding-3-small`.

Full stack (Qdrant + Surreal + Archon + Docs MCP Web UI):

```bash
<STACK_ROOT>/scripts/stack_infra.sh up full
```

Surreal profile details:
- Runs both `surrealmcp` (`18080`) and local `surrealdb` (`18083`) plus Surrealist (`18082`).
- Surrealist auto-loads a managed connection from a generated runtime file:
  - `<STACK_ROOT>/tmp/surrealist-instance.json`
  - generated by `stack_infra.sh` from values in `<STACK_ROOT>/.secrets.env` (or safe defaults)
- Default local DB auth in this stack: `root` / `root` (local dev only).

Core-only (Qdrant backend + dashboard):

```bash
<STACK_ROOT>/scripts/stack_infra.sh up core
```

Docs UI only profile (plus qdrant):

```bash
<STACK_ROOT>/scripts/stack_infra.sh up docs
```

Runtime env files generated by scripts:
- `<STACK_ROOT>/tmp/ai-mcp-infra.env` (docs-mcp provider settings)
- `<STACK_ROOT>/tmp/ai-mcp-archon.env` (archon runtime settings)

Filesystem mounts for Docker MCP services (read-only):
- Host root `/` is mounted as `/hostfs` inside MCP containers.
- Host `/Users` is mounted as `/Users` for direct-path indexing (no translation needed for your repos).
- Override sources in `<STACK_ROOT>/.secrets.env`:
  - `MCP_HOST_FS_ROOT=/`
  - `MCP_HOST_FS_USERS=/Users`

Example local indexing path for docs-mcp:
- `file://<TS_REPO>/README.md`
- For non-`/Users` paths, use `/hostfs` mapping inside the containerized tool flow.

## 2) Apply MCP Profile

Recommended default:

```bash
<STACK_ROOT>/scripts/stack_apply.sh core --agents codex,claude,opencode --codex-target both
```

Maximum context profile:

```bash
<STACK_ROOT>/scripts/stack_apply.sh full --agents codex,claude,opencode --codex-target both
```

One-command activate (infra + profile together):

```bash
<STACK_ROOT>/scripts/stack_activate.sh full
```

One-command activate with docs UI but core MCP profile:

```bash
<STACK_ROOT>/scripts/stack_activate.sh core-docs
```

Disable managed MCP profile:

```bash
<STACK_ROOT>/scripts/stack_apply.sh none --agents codex,claude,opencode --codex-target both
```

Global dynamic MCP behavior:
- `mcpx-qdrant` automatically maps current repo to a collection (`proj-<repo-slug>`).
- `mcpx-lsp` automatically picks workspace root from current directory and chooses Python vs TypeScript LSP by repo markers.
- This keeps global agent configs project-agnostic.

Optional per-repo overrides:
- Add `.mcp-stack.env` to repository root (only if you need special behavior).
- Template: `<STACK_ROOT>/configs/mcp-stack.env.example`
- Parsing mode: strict `KEY=VALUE` (no shell execution).

## 3) Check Status

```bash
<STACK_ROOT>/scripts/stack_infra.sh status
<STACK_ROOT>/scripts/stack_doctor.sh full
<STACK_ROOT>/scripts/stack_versions.sh show
<STACK_ROOT>/scripts/stack_versions.sh check
codex mcp list
CODEX_HOME="$HOME/.codex-mcp-eval" codex mcp list
claude mcp list
opencode mcp list
```

Upgrade flow (digest-pinned images):

```bash
<STACK_ROOT>/scripts/stack_versions.sh check
<STACK_ROOT>/scripts/stack_versions.sh refresh
<STACK_ROOT>/scripts/stack_infra.sh up full
<STACK_ROOT>/scripts/stack_doctor.sh full
```

UI endpoints in `full` profile:
- `http://127.0.0.1:6333/dashboard/` (Qdrant)
- `http://127.0.0.1:13737` (Archon UI)
- `http://127.0.0.1:18082` (Surrealist)
- `http://127.0.0.1:18083/rpc` (SurrealDB RPC endpoint)
- `http://127.0.0.1:16280` (Docs MCP UI)

## 4) Stop Infra

```bash
<STACK_ROOT>/scripts/stack_infra.sh down full
```

## 5) Restore Everything

```bash
<STACK_ROOT>/scripts/restore_original.sh
```

Detailed runbook:
- `<STACK_ROOT>/report/FINAL_PRODUCTION_RECOMMENDATION.md`
