x-docs-mcp-env-file: &docs_mcp_env_file
  - path: ${INFRA_RUNTIME_ENV_FILE:-./tmp/ai-mcp-infra.env}
    required: false

x-docs-mcp-volumes: &docs_mcp_volumes
  - ./volumes/docs-mcp-data:/data
  - ./volumes/docs-mcp-config:/config
  - ${MCP_HOST_FS_ROOT:-/}:/hostfs:ro
  - ${MCP_HOST_FS_USERS:-/Users}:/Users:ro

services:
  qdrant:
    image: ${QDRANT_IMAGE:-qdrant/qdrant:v1.15.4}
    container_name: ai-mcp-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./volumes/qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/127.0.0.1/6333'"]
      interval: 10s
      timeout: 5s
      retries: 10

  chroma:
    image: ${CHROMA_IMAGE:-chromadb/chroma:1.0.20}
    container_name: ai-mcp-chroma
    ports:
      - "18000:8000"
    environment:
      IS_PERSISTENT: "TRUE"
      PERSIST_DIRECTORY: /chroma/chroma
      CHROMA_SERVER_NOFILE: 65535
    volumes:
      - ./volumes/chroma:/chroma/chroma
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8000/api/v2/heartbeat"]
      interval: 10s
      timeout: 5s
      retries: 10

  postgres:
    image: ${PGVECTOR_IMAGE:-pgvector/pgvector:pg16}
    container_name: ai-mcp-postgres
    ports:
      - "15432:5432"
    environment:
      POSTGRES_USER: mcp
      POSTGRES_PASSWORD: mcp
      POSTGRES_DB: mcp
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcp -d mcp"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: ${REDIS_IMAGE:-redis:7.4-alpine}
    container_name: ai-mcp-redis
    ports:
      - "16379:6379"
    volumes:
      - ./volumes/redis:/data
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

  neo4j:
    image: ${NEO4J_IMAGE:-neo4j:5.26.19}
    container_name: ai-mcp-neo4j
    ports:
      - "${NEO4J_HTTP_PORT:-17474}:7474"
      - "${NEO4J_BOLT_PORT:-17687}:7687"
    environment:
      NEO4J_AUTH: ${NEO4J_DOCKER_AUTH:-neo4j/testpass}
      NEO4J_PLUGINS: '["apoc"]'
    volumes:
      - ./volumes/neo4j:/data
      - ./volumes/neo4j-logs:/logs
    healthcheck:
      test: ["CMD-SHELL", "bash -c '</dev/tcp/127.0.0.1/7687'"]
      interval: 10s
      timeout: 5s
      retries: 20

  surrealmcp:
    image: ${SURREALMCP_IMAGE:-surrealdb/surrealmcp:latest}
    container_name: ai-mcp-surreal-mcp
    ports:
      - "18084:8080"
    volumes:
      - ${MCP_HOST_FS_ROOT:-/}:/hostfs:ro
      - ${MCP_HOST_FS_USERS:-/Users}:/Users:ro
    command:
      [
        "start",
        "--auth-disabled",
        "--bind-address",
        "0.0.0.0:8080",
        "--rate-limit-rps",
        "${SURREAL_MCP_RATE_LIMIT_RPS:-2000}",
        "--rate-limit-burst",
        "${SURREAL_MCP_RATE_LIMIT_BURST:-4000}",
        "--server-url",
        "${SURREAL_MCP_SERVER_URL:-http://127.0.0.1:18080}",
      ]
    healthcheck:
      test: ["CMD", "/surrealmcp", "--version"]
      interval: 10s
      timeout: 5s
      retries: 10

  surrealmcp-compat:
    image: ${SURREALMCP_COMPAT_IMAGE:-node:20-alpine}
    container_name: ai-mcp-surreal-mcp-compat
    depends_on:
      surrealmcp:
        condition: service_started
    ports:
      - "18080:8080"
    volumes:
      - ./compat/surrealmcp-compat.mjs:/app/surrealmcp-compat.mjs:ro
    command: ["node", "/app/surrealmcp-compat.mjs"]
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://localhost:8080/health').then(r=>process.exit(r.status===200?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 10s
      timeout: 5s
      retries: 10

  surrealdb:
    image: ${SURREALDB_IMAGE:-surrealdb/surrealdb:v2.3.10}
    container_name: ai-mcp-surrealdb
    ports:
      - "${SURREALDB_RPC_PORT:-18083}:8000"
    command:
      [
        "start",
        "--log",
        "info",
        "--bind",
        "0.0.0.0:8000",
        "--user",
        "${SURREALDB_ROOT_USER:-root}",
        "--pass",
        "${SURREALDB_ROOT_PASS:-root}",
        "rocksdb:///data/surrealdb",
      ]
    volumes:
      - ./volumes/surrealdb:/data

  surrealist:
    image: ${SURREALIST_IMAGE:-surrealdb/surrealist:latest}
    container_name: ai-mcp-surrealist
    ports:
      - "18082:8080"
    volumes:
      - ${SURREALIST_INSTANCE_FILE:-./surrealist/instance.json}:/usr/share/nginx/html/instance.json:ro

  docs-mcp-web:
    image: ${DOCS_MCP_IMAGE:-ghcr.io/arabold/docs-mcp-server:latest}
    container_name: ai-mcp-docs-mcp
    ports:
      - "${DOCS_MCP_PUBLIC_PORT:-16280}:${DOCS_MCP_SERVER_PORTS_DEFAULT:-6280}"
    env_file: *docs_mcp_env_file
    command:
      [
        "server",
        "--protocol",
        "${DOCS_MCP_SERVER_PROTOCOL:-http}",
        "--host",
        "${DOCS_MCP_SERVER_HOST:-0.0.0.0}",
        "--port",
        "${DOCS_MCP_SERVER_PORTS_DEFAULT:-6280}",
        "--resume",
      ]
    volumes: *docs_mcp_volumes
